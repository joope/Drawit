<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="initial-scale=1.0" />
  <title>Draw</title>
</head>
<body 
  style="
    margin: 0; 
    user-select: none;
    background-color: #313131;">
    
  <canvas
    id="cx"
    style="
      display: block; 
      margin: 0 auto 10px auto;
      background-color: beige;
      width: 100%;
      max-width: 1000px;
      " 
    width="500"
    height="500">
  </canvas>
  <div 
    class="wheel" 
    id="colorWheel" 
    style="
      width: 200px;
      height: 200px;
      margin: 10px auto;">
  </div>
  <script src="iro.min.js"></script>
  <script>

    var colorWheel = iro.ColorWheel("#colorWheel", {
      width: 200,
      height: 200,
      padding: 4,
      sliderMargin: 24,
      markerRadius: 8,
      color: "#25c900",
      CSS: {} // apply colors to any elements
    });
    
    colorWheel.on("color:change", function(color){
      stroke.color = color.hexString;
    });
    
    var ws = new WebSocket("ws://" + location.hostname + ":8082");
    
    ws.onerror = function (error) {
      console.log('WebSocket Error ' + error);
    };
    
    ws.onmessage = function (e) {
      if (e.data){
        var d = JSON.parse(e.data);  
        if (d['type'] == 'stroke') {
          drawStroke(d.data);
        }
        if (d['type'] == 'init'){
          loadImage(d.data);
        }
      }

    };

    var c = document.querySelector('#cx');
    var c_w = 500;

    var stroke = {
      'x': [], 
      'y': [],
      'width': 1,
      'color': "#25c900"
      };

    var paint = false;
    var counter = 0;

    var imgData;
    var ctx = c.getContext("2d");
    ctx.imageSmoothingEnabled = true;
    
    c.addEventListener('touchstart', startStroke);
    c.addEventListener('touchmove', moveStroke);
    c.addEventListener('touchend', endStroke);

    c.addEventListener('mousedown', startStroke);
    c.addEventListener('mousemove', moveStroke);
    c.addEventListener('mouseup', endStroke);

    function saveImage(){
      imgData = ctx.getImageData(0, 0, 500, 500);
      socketSend('image', c.toDataURL());
    }
    
    function loadImage(image) {
      var img = new Image();
      img.src = image;
      img.onload = function(){
        ctx.drawImage(this, 0, 0);
      }
    }

    function drawStroke(s) {
      ctx.strokeStyle = s.color;
      ctx.beginPath();
      ctx.moveTo(s.x[0], s.y[0]);
      for (var i = 1; i < s.x.length; i++) {
        ctx.lineTo(s.x[i], s.y[i]);
      }
      ctx.stroke();
    }
    
    function startStroke(e){
      paint = true;
      console.log(e);
      saveCoordinates(e);
    }
    
    function moveStroke(e){
      if (paint) {
        saveCoordinates(e);
        drawStroke(stroke);
        counter++;
      }

      if(counter > 5) {
        socketSend('stroke', stroke);
        counter = 0;
      }
    }
    
    function endStroke(e){
      paint = false;
      drawStroke(stroke);
      saveImage();
      socketSend('stroke', stroke);
      clearStroke();
    }

    function clearStroke(){
      stroke.x = [];
      stroke.y = [];
      counter = 0;
    }
    
    function saveCoordinates(e) {
      var x, y;
      if (e.touches) {
        if (e.touches.length == 1) {
          var touch = e.touches[0];
          x = touch.pageX-touch.target.offsetLeft; //minus border width
          y = touch.pageY-touch.target.offsetTop;
          e.preventDefault();
        }
      } else {
        x = e.offsetX;
        y = e.offsetY;
      }
      var scale = c_w / c.offsetWidth;
      console.log(scale, x, y);
      stroke.x.push(parseInt(scale * x));
      stroke.y.push(parseInt(scale * y));
    }
    
    function socketSend(type, data){
      if(ws.readyState !== ws.OPEN){
         console.log('disconnected');
         reconnect();
         return;
      }
    
      var d = {};
      d.type = type;
      d.data = data;
      console.log(d);
      ws.send(JSON.stringify(d));
    }
    
    function reconnect(){
      ws = new WebSocket("ws://" + location.hostname + ":8082");
    }

  </script>
</body>
</html>
