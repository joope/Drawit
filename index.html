<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <title>Draw</title>
</head>
<body style="margin: 0;">
  <canvas
    id="cx"
    style="display: block; margin: 0 auto; border: 10px solid gray;"
    width="500" height="500">
  </canvas>
  <button id="get">get</button>
  <button id="put">put</button>
  <script>

    var ws = new WebSocket("ws://" + location.hostname + ":8082");
    
    ws.onopen = function () {
    };
    ws.onerror = function (error) {
      console.log('WebSocket Error ' + error);
    };
    
    // Log messages from the server
    ws.onmessage = function (e) {
      if (e.data){
        
        var d = JSON.parse(e.data);  
        console.log(d);
        if (d['type'] == 'stroke') {
          drawStroke(d.data);
        }
        if (d['type'] == 'init'){
          loadImage(d.data);
        }
      }

    };

    var c = document.querySelector('#cx');

    var stroke = {
      'x': [], 
      'y': [],
      'width': 1,
      'color': '#000000'
      };

    var paint = false;
    var counter = 0;

    var imgData;
    var ctx = c.getContext("2d");

    c.addEventListener('mousedown', function(e) {
      paint = true;
      saveStroke(e);
    })

    c.addEventListener('mousemove', function(e){
      if (paint) {
        saveStroke(e);
        drawStroke(stroke);
        counter++;
      }

      if(counter > 5) {
        socketSend('stroke', stroke);
        counter = 0;
      }
    })

    c.addEventListener('mouseup', function(e){
      paint = false;
      drawStroke(stroke);
      saveImage();
      socketSend('stroke', stroke);
      clearStroke();
    })

    function saveImage(){
      imgData = ctx.getImageData(0, 0, 500, 500);
      socketSend('image', c.toDataURL());
    }
    
    function loadImage(image) {
      var img = new Image();
      img.src = image;
      img.onload = function(){
        ctx.drawImage(this, 0, 0);
      }
    }

    function drawStroke(s){
      ctx.beginPath();
      ctx.moveTo(s.x[0], s.y[0]);
      for (var i = 1; i < s.x.length; i++) {
        ctx.lineTo(s.x[i], s.y[i]);
      }
      ctx.stroke();
    }

    function saveStroke(e){
      stroke.x.push(e.offsetX);
      stroke.y.push(e.offsetY);
    }

    function clearStroke(){
      stroke.x = [];
      stroke.y = [];
      counter = 0;
    }
    
    function socketSend(type, data){
      var d = {};
      d.type = type;
      d.data = data;
      console.log(d);
      ws.send(JSON.stringify(d));
    }
    
        // Define some variables to keep track of the touch position
    var touchX,touchY;

    c.addEventListener('touchstart', function(e) {
        getTouchPos(e);
        paint = true;
        saveStroke(e);
        // Prevents an additional mousedown event being triggered
        event.preventDefault();
    })

    c.addEventListener('touchmove', function(e) { 
        // Update the touch co-ordinates
        getTouchPos(e);
        if (paint) {
          saveStroke(e);
          drawStroke(stroke);
          counter++;
        }

        if(counter > 5) {
          socketSend('stroke', stroke);
          counter = 0;
        }

        // During a touchmove event, unlike a mousemove event, we don't need to check if the touch is engaged, since there will always be contact with the screen by definition.

        // Prevent a scrolling action as a result of this touchmove triggering.
        event.preventDefault();
    })
    
    c.addEventListener('touchend', function(e){
      paint = false;
      drawStroke(stroke);
      saveImage();
      socketSend('stroke', stroke);
      clearStroke();
    })

    // Get the touch position relative to the top-left of the canvas
    // When we get the raw values of pageX and pageY below, they take into account the scrolling on the page
    // but not the position relative to our target div. We'll adjust them using "target.offsetLeft" and
    // "target.offsetTop" to get the correct values in relation to the top left of the canvas.
    function getTouchPos(e) {
        if (!e)
            var e = event;

        if (e.touches) {
            if (e.touches.length == 1) { // Only deal with one finger
                var touch = e.touches[0]; // Get the information for finger #1
                touchX=touch.pageX-touch.target.offsetLeft;
                touchY=touch.pageY-touch.target.offsetTop;
            }
        }
    }

  </script>
</body>
</html>
